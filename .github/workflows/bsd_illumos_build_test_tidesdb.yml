name: BSD and Illumos TidesDB Build & Test

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  freebsd-build:
    runs-on: ubuntu-latest
    name: FreeBSD 14.0 x64
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Build on FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          release: '14.0'
          usesh: true
          prepare: |
            pkg install -y cmake pkgconf zstd liblz4 snappy
          run: |
            echo "=== FreeBSD System Info ==="
            uname -a
            freebsd-version
            echo ""
            echo "=== Checking for sys/sysinfo.h ==="
            if [ -f /usr/include/sys/sysinfo.h ]; then
              echo "✓ sys/sysinfo.h exists"
            else
              echo "✗ sys/sysinfo.h NOT FOUND (expected on FreeBSD)"
            fi
            echo ""
            echo "=== Checking for sysinfo() function ==="
            cat > test_sysinfo.c << 'EOF'
            #include <sys/sysinfo.h>
            int main() {
                struct sysinfo si;
                sysinfo(&si);
                return 0;
            }
            EOF
            if cc -o test_sysinfo test_sysinfo.c 2>&1; then
              echo "✓ sysinfo() compiles successfully"
              rm -f test_sysinfo test_sysinfo.c
            else
              echo "✗ sysinfo() compilation failed (expected)"
              rm -f test_sysinfo test_sysinfo.c
            fi
            echo ""
            echo "=== Attempting CMake configuration ==="
            if cmake -S . -B build -DTIDESDB_BUILD_TESTS=ON -DTIDESDB_WITH_SANITIZER=OFF; then
              echo "✓ CMake configuration succeeded"
            else
              echo "✗ CMake configuration failed"
              exit 1
            fi
            echo ""
            echo "=== Attempting build (showing first error) ==="
            if cmake --build build --config Release 2>&1 | tee build.log; then
              echo "✓ Build succeeded!"
            else
              echo "✗ Build failed - showing first 50 lines of errors:"
              grep -A 5 "error:" build.log | head -50 || cat build.log | head -100
              exit 1
            fi

  openbsd-build:
    runs-on: ubuntu-latest
    name: OpenBSD 7.4 x64
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Build on OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          release: '7.4'
          usesh: true
          prepare: |
            pkg_add cmake lz4 zstd snappy
          run: |
            echo "=== OpenBSD System Info ==="
            uname -a
            echo ""
            echo "=== Checking for sys/sysinfo.h ==="
            if [ -f /usr/include/sys/sysinfo.h ]; then
              echo "✓ sys/sysinfo.h exists"
            else
              echo "✗ sys/sysinfo.h NOT FOUND (expected on OpenBSD)"
            fi
            echo ""
            echo "=== Attempting CMake configuration ==="
            if cmake -S . -B build -DTIDESDB_BUILD_TESTS=ON -DTIDESDB_WITH_SANITIZER=OFF; then
              echo "✓ CMake configuration succeeded"
            else
              echo "✗ CMake configuration failed"
              exit 1
            fi
            echo ""
            echo "=== Attempting build (showing first error) ==="
            if cmake --build build --config Release 2>&1 | tee build.log; then
              echo "✓ Build succeeded!"
            else
              echo "✗ Build failed - showing errors:"
              grep -A 5 "error:" build.log | head -50 || cat build.log | head -100
              exit 1
            fi

  netbsd-build:
    runs-on: ubuntu-latest
    name: NetBSD 9.3 x64
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Build on NetBSD
        uses: vmactions/netbsd-vm@v1
        with:
          release: '9.3'
          usesh: true
          prepare: |
            /usr/sbin/pkg_add cmake lz4 zstd snappy
          run: |
            echo "=== NetBSD System Info ==="
            uname -a
            echo ""
            echo "=== Checking for sys/sysinfo.h ==="
            if [ -f /usr/include/sys/sysinfo.h ]; then
              echo "✓ sys/sysinfo.h exists"
            else
              echo "✗ sys/sysinfo.h NOT FOUND (expected on NetBSD)"
            fi
            echo ""
            echo "=== Attempting CMake configuration ==="
            if cmake -S . -B build -DTIDESDB_BUILD_TESTS=ON -DTIDESDB_WITH_SANITIZER=OFF; then
              echo "✓ CMake configuration succeeded"
            else
              echo "✗ CMake configuration failed"
              exit 1
            fi
            echo ""
            echo "=== Attempting build (showing first error) ==="
            if cmake --build build --config Release 2>&1 | tee build.log; then
              echo "✓ Build succeeded!"
            else
              echo "✗ Build failed - showing errors:"
              grep -A 5 "error:" build.log | head -50 || cat build.log | head -100
              exit 1
            fi

  omnios-build:
    runs-on: ubuntu-latest
    name: OmniOS (Illumos) r151048
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Build on OmniOS (Illumos)
        uses: vmactions/omnios-vm@v1
        with:
          release: 'r151048'
          usesh: true
          prepare: |
            pkg install cmake gcc-13 library/lz4 library/zstd compress/snappy
          run: |
            echo "=== OmniOS/Illumos System Info ==="
            uname -a
            echo ""
            echo "=== Checking for sys/sysinfo.h ==="
            if [ -f /usr/include/sys/sysinfo.h ]; then
              echo "✓ sys/sysinfo.h exists"
            else
              echo "✗ sys/sysinfo.h NOT FOUND (expected on Illumos)"
            fi
            echo ""
            echo "=== Attempting CMake configuration ==="
            export CC=gcc
            export CXX=g++
            if cmake -S . -B build -DTIDESDB_BUILD_TESTS=ON -DTIDESDB_WITH_SANITIZER=OFF; then
              echo "✓ CMake configuration succeeded"
            else
              echo "✗ CMake configuration failed"
              exit 1
            fi
            echo ""
            echo "=== Attempting build (showing first error) ==="
            if cmake --build build --config Release 2>&1 | tee build.log; then
              echo "✓ Build succeeded!"
            else
              echo "✗ Build failed - showing errors:"
              grep -A 5 "error:" build.log | head -50 || cat build.log | head -100
              exit 1
            fi

  dragonflybsd-build:
    runs-on: ubuntu-latest
    name: DragonFlyBSD 6.4 x64
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Build on DragonFlyBSD
        uses: vmactions/dragonflybsd-vm@v1
        with:
          release: '6.4.0'
          usesh: true
          prepare: |
            pkg install -y cmake pkgconf zstd liblz4 snappy
          run: |
            echo "=== DragonFlyBSD System Info ==="
            uname -a
            echo ""
            echo "=== Checking for sys/sysinfo.h ==="
            if [ -f /usr/include/sys/sysinfo.h ]; then
              echo "✓ sys/sysinfo.h exists"
            else
              echo "✗ sys/sysinfo.h NOT FOUND (expected on DragonFlyBSD)"
            fi
            echo ""
            echo "=== Attempting CMake configuration ==="
            if cmake -S . -B build -DTIDESDB_BUILD_TESTS=ON -DTIDESDB_WITH_SANITIZER=OFF; then
              echo "✓ CMake configuration succeeded"
            else
              echo "✗ CMake configuration failed"
              exit 1
            fi
            echo ""
            echo "=== Attempting build (showing first error) ==="
            if cmake --build build --config Release 2>&1 | tee build.log; then
              echo "✓ Build succeeded!"
            else
              echo "✗ Build failed - showing errors:"
              grep -A 5 "error:" build.log | head -50 || cat build.log | head -100
              exit 1
            fi